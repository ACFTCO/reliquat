<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  	<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <title>cong√©s et repos</title>
	<link rel="icon" type="image/png" href="https://i.postimg.cc/bvpTrPxK/day-off-vector-cartoon-dai-sticker-557176-wh860-copy-512x512.png">
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "4103db19-8ea6-476f-b4a0-392f67d176e9",
    });
  });
</script>
	<style>
    /* All previous styles remain exactly the same */
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #f4f7f6 0%, #e8f0fe 100%);
      margin: 0;
      padding: 0;
      color: #333;
      min-height: 100vh;
    }

    header {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            width: calc(100% - 40px);
            max-width: 800px;
            margin: 10px auto;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .reliquat {
            font-size: 1.2rem;
            margin-top: 8px;
            font-weight: 500;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .reliquat:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            header {
                padding: 15px;
                margin: 5px auto;
            }

            header h1 {
                font-size: 1.8rem;
            }

            .reliquat {
                font-size: 1rem;
                padding: 4px 12px;
            }
        }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    form {
      max-width: 500px;
      margin: 30px auto;
      padding: 30px;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    form:hover {
      transform: translateY(-5px);
    }

    .input-group {
      position: relative;
      margin-bottom: 20px;
    }

    form label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    form input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e3e3e3;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    form input:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }

    .show-password {
      position: absolute;
      right: 10px;
      top: 40px;
      cursor: pointer;
      color: #666;
    }

    form button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    form button:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .help-text {
      font-size: 0.9rem;
      color: #555;
      margin-top: 20px;
      text-align: center;
      line-height: 1.5;
    }

    .help-text a {
      display: block;
      padding: 10px 15px;
      margin: 10px auto;
      background-color: #f8f9fa;
      color: #007bff;
      text-decoration: none;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-width: 250px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .help-text a:hover {
      background-color: #e9ecef;
      text-decoration: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    #userDetails {
      max-width: 600px;
      margin: 30px auto;
      background-color: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #userDetails h2 {
    
      margin: 0;
      margin-bottom: 10px;
      font-size: 20px;
      font-weight: bold;
      color: #007bff;
    }

    #userFunction {
      margin: 5px 0;
      font-size: 12px;
      color: #dc3545 !important;
      font-weight: bold;
    }

    table {
      margin: 30px auto;
      border-collapse: separate;
      border-spacing: 0;
      width: 96%;
      max-width: 1000px;
      background-color: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    table thead {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
     font-size : 15px;
    }

    table th {
      padding: 18px;
      text-align: center;
      font-weight: bold;
      
    }

    table td {
      padding: 8px;
      text-align: center;
      border: 1px solid #eee;
      font-size : 10px;
    
    }

    table tbody tr:nth-child(odd) {
      background-color: #f8f9fa;
    }

    table tbody tr:hover {
      background-color: #f2f7ff;
      transition: background-color 0.3s ease;
    }
    

    .error-message {
      color: #dc3545;
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      background-color: #fff;
      border-radius: 8px;
      border: 1px solid #dc3545;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    .loading::after {
      content: "...";
      animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }

    /* Logout button styles remain the same, just moved position */
    .logout-button {
      padding: 5px 8px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      font-size: 10px;
      font-weight: bold;
      transition: all 0.3s ease;
      z-index: 1000;
      display: none;
      margin-top: 10px;  /* Added margin-top for spacing */
    }

    .logout-button:hover {
      background-color: #c82333;
      transform: scale(1.05);
    }

    #loginSection {
      transition: opacity 0.3s ease-in-out;
    }

    .hidden {
      display: none !important;
    }

    #dataSection {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    #dataSection.visible {
      display: block;
      opacity: 1;
    }
        @media screen and (max-width: 400px) {
      table {
        font-size: 11px;
      }

      table th, table td {
        padding: 6px 3px;
      }
    }
      .input-group {
      position: relative;
      margin-bottom: 20px;
    }

    .input-icon {
      position: absolute;
      left: 12px;
      top: 40px;
      color: #666;
      font-size: 18px;
    }

    form input {
      width: 100%;
      padding: 12px 12px 12px 35px; /* Augmentation du padding gauche pour l'ic√¥ne */
      border: 2px solid #e3e3e3;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
.request-button {
    width: 70%; /* ŸÑÿ¨ÿπŸÑŸá ÿ®ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ */
    margin-bottom: 10px; /* ŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜŸá Ÿàÿ®ŸäŸÜ ÿ≤ÿ± D√©connexion */
    padding: 5px 8px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 18px;
    cursor: pointer;
    font-size: 10px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: block;
}

.logout-button {
    width: 70%; /* ŸÑÿ¨ÿπŸÑŸá ÿ®ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ ÿ£Ÿäÿ∂Ÿãÿß */
}
    .request-button:hover {
      background-color: #218838;
      transform: scale(1.05);
    }
    #userDetails {
    display: flex;
    flex-direction: column;
    align-items: center; /* ŸÑŸàÿ∂ÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿµŸÅ ÿ£ŸÅŸÇŸäÿßŸã */
    text-align: center;
}


.request-button, .logout-button {
    width: auto; /* Ÿäÿ™ŸÉŸäŸÅ ŸÖÿπ ŸÖÿ≠ÿ™ŸàÿßŸá */
    max-width: 200px; /* ÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑÿπÿ±ÿ∂ */
    margin: 5px 0; /* ŸÖÿ≥ÿßŸÅÿ© ÿ±ÿ£ÿ≥Ÿäÿ© ÿ®ŸäŸÜ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */
    padding: 5px 15px; /* ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ®ÿßÿØŸäŸÜÿ¨ ŸÇŸÑŸäŸÑÿßŸã */
}

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .modal-content select, 
    .modal-content input, 
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #e3e3e3;
      border-radius: 8px;
      box-sizing: border-box;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex-grow: 1;
      margin: 0 10px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-buttons .submit-btn {
      background: linear-gradient(135deg, #28a745 0%, #218838 100%);
      color: white;
      
    }

    .modal-buttons .cancel-btn {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }
    .year-header {
    text-align: center;
    margin-bottom: 15px;
}

.year-header h3 {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    display: inline-block;
    font-size: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    letter-spacing: 1px;
    transition: transform 0.3s ease;
    
}

.year-header h3:hover {
    transform: scale(1.05);
}
  </style>
</head>
<body>
<header>
   <h1>ACFTC OUJDA</h1>
      <div class="reliquat">RELIQUAT</div>
      <div id="totalContributionsDisplay" class="total-contributions"></div>
    </header>

  <div class="container">
    <div id="loginSection">
      <form id="loginForm">
        <div class="input-group">
          <label for="username">Nom d'utilisateur :</label>
          <span class="input-icon">üë§</span>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="input-group">
          <label for="password">Mot de passe :</label>
          <span class="input-icon">üîí</span>
          <input type="password" id="password" name="password" required>
          <span class="show-password" onclick="togglePassword()">üëÅÔ∏è</span>
        </div>
        <button type="submit">Afficher les donn√©es</button>

        <div class="help-text">
  <a href="whatsapp://send?text=Bonjour, j'ai oubli√© mon mot de passe. Voici mes informations : Nom et Matricule&phone=0641434629">
    Mot de passe oubli√©
  </a>
  
  <!-- ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≤ÿ± ŸáŸÜÿß -->
  <a href="#" onclick="openNewUserModal()" class="new-user-link">
  Nouveau Utilisateur
</a>
</div>
      </form>
    </div>

    <div id="dataSection">
      <div id="userDetails">
        <h2 id="userName"></h2>
        <p id="userFunction"></p>
        <p id="yearDisplay" style="font-weight: bold; font-size: 10px;color: #007bff;"></p>
        <button id="logoutBtn" class="logout-button">D√©connexion</button>
      </div>
      <div id="result"></div>
    </div>
  </div>
<div id="leaveRequestModal" class="modal">
  <div class="modal-content">
    <h2>Demande de Cong√©/Repos</h2>
    <form id="leaveRequestForm">
      <label for="recipient">Envoyer √† :</label>
      <select id="recipient" required>
        <option value="">S√©lectionnez un responsable</option>
        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ° Ÿáÿ∞Ÿá ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿØŸäŸÜÿßŸÖŸäŸÉŸäŸãÿß -->
        	
      </select>

      <select id="leaveType" required>
        <option value="">S√©lectionnez le type</option>
        <option value="un Cong√©">Cong√©</option>
        <option value="Repos">Repos</option>
      </select>

      <label for="startDate">Date de d√©but:</label>
      <input type="date" id="startDate" required>

      <label for="endDate">Date de fin:</label>
      <input type="date" id="endDate" required>

      <label for="reason">Motif:</label>
      <textarea id="reason" rows="4" placeholder="Expliquez la raison de votre demande (optionnel)"></textarea>

      <div class="modal-buttons">
        <button type="button" class="cancel-btn" onclick="closeLeaveRequestModal()">Annuler</button>
        <button type="submit" class="submit-btn">Envoyer</button>
      </div>
    </form>
  </div>
</div>


<!-- ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ -->
<div id="newUserModal" class="modal">
  <div class="modal-content">
    <h2>Nouveau Utilisateur</h2>
    <form id="newUserForm">
      <input type="text" id="newUserNom" placeholder="Nom et Pr√©nom" required>
      <input type="text" id="newUserUsername" placeholder="Nom d'utilisateur" required>
      <input type="password" id="newUserPassword" placeholder="Mot de passe" required>
      
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" onclick="closeNewUserModal()">Annuler</button>
        <button type="submit" class="submit-btn">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<script>
    function openNewUserModal() {
  document.getElementById('newUserModal').style.display = 'flex';
}

function closeNewUserModal() {
  document.getElementById('newUserModal').style.display = 'none';
}

    function closeNewUserModal() {
        document.getElementById('newUserModal').style.display = 'none';
    }

    const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
    const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";
    const sheetName = "2024";

    function togglePassword() {
  const passwordInput = document.getElementById("password");
  const eyeIcon = document.querySelector(".show-password");
  
  if (passwordInput.type === "password") {
    passwordInput.type = "text";
    eyeIcon.textContent = "üö´";
  } else {
    passwordInput.type = "password";
    eyeIcon.textContent = "üëÅÔ∏è";
  }
}

    function showLogoutButton() {
      document.getElementById('logoutBtn').style.display = 'block';
    }

    function hideLogoutButton() {
      document.getElementById('logoutBtn').style.display = 'none';
    }

    function logout() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('dataSection').classList.remove('visible');
      document.getElementById('loginForm').reset();
      hideLogoutButton();
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const username = document.getElementById("username").value.trim().toLowerCase();
      const password = document.getElementById("password").value.trim();
      const userPassword = `${username}:${password}`;

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "<div class='loading'>Chargement des donn√©es</div>";

      try {
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`
        );
        const data = await response.json();

        if (!data.values) {
          resultDiv.innerHTML = "<p class='error-message'>Erreur lors du chargement des donn√©es. V√©rifiez les param√®tres.</p>";
          return;
        }

        const rows = data.values;
        const userRow = rows.find(row => row[26]?.toLowerCase() === userPassword.toLowerCase());

        if (!userRow) {
          resultDiv.innerHTML = "<p class='error-message'>Nom d'utilisateur ou mot de passe incorrect.</p>";
          return;
        }

        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dataSection').classList.add('visible');
        showLogoutButton();

        const userName = userRow[0] || "Non sp√©cifi√©";
        const userFunction = userRow[1] || "Non sp√©cifi√©";
        document.getElementById("userName").textContent = userName;
        document.getElementById("userFunction").textContent = userFunction;
        document.getElementById("yearDisplay").textContent = `Ann√©e : ${sheetName}`;

        const months = [
          "Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
          "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"
        ];

        let table = `
          <table>
            <thead>
              <tr>
                <th>Mois</th>
                <th>CONG√â</th>
                <th>REPOS</th>
              </tr>
            </thead>
            <tbody>
        `;

        for (let i = 0; i < months.length; i++) {
          const conge = userRow[2 + i * 2] || "Non disponible";
          const repos = userRow[3 + i * 2] || "Non disponible";
          table += `
            <tr>
              <td>${months[i]}</td>
              <td>${conge}</td>
              <td>${repos}</td>
            </tr>
          `;
        }

        table += `
            </tbody>
          </table>
        `;

        resultDiv.innerHTML = table;
      } catch (error) {
        console.error(error);
        resultDiv.innerHTML = "<p class='error-message'>Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.</p>";
      }
    });
   const userDetailsDiv = document.getElementById('userDetails');

const leaveRequestBtn = document.createElement('button');
leaveRequestBtn.id = 'leaveRequestBtn';
leaveRequestBtn.className = 'request-button';
leaveRequestBtn.textContent = 'Demande Cong√©/Repos';
leaveRequestBtn.style.display = 'block';

const logoutBtn = document.getElementById('logoutBtn');

// ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤ÿ± ŸÇÿ®ŸÑ ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
userDetailsDiv.insertBefore(leaveRequestBtn, logoutBtn);
    // Modal functions
    function openLeaveRequestModal() {
      document.getElementById('leaveRequestModal').style.display = 'flex';
    }

    function closeLeaveRequestModal() {
      document.getElementById('leaveRequestModal').style.display = 'none';
    }

    // Event listener for Leave Request button
    document.getElementById('leaveRequestBtn').addEventListener('click', openLeaveRequestModal);

    // Handle form submission
    document.getElementById('leaveRequestForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
  const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";
  const demandeCong√©Sheet = "DEMANDE CONG√â";

  try {
    // Fetch names and WhatsApp numbers
    const response = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${demandeCong√©Sheet}?key=${apiKey}`
    );
    const data = await response.json();

    if (!data.values) {
      alert('Erreur de chargement des donn√©es');
      return;
    }

    // Populate the recipient dropdown (if not already populated)
    const recipientSelect = document.getElementById('recipient');
    if (recipientSelect.children.length === 1) { // Avoid re-adding options
      data.values.slice(1).forEach((row) => {
        const option = document.createElement("option");
        option.value = row[2]; // WhatsApp number in column C
        option.textContent = row[1]; // Name in column B
        recipientSelect.appendChild(option);
      });
    }

    // Get form values
    const selectedRecipient = recipientSelect.options[recipientSelect.selectedIndex]; // Selected option
    const recipientNumber = selectedRecipient.value;
    const recipientName = selectedRecipient.textContent;

    const leaveType = document.getElementById('leaveType').value;
    const startDate = document.getElementById('startDate').value.split('-').reverse().join('-'); // Convert to DD-MM-YYYY
    const endDate = document.getElementById('endDate').value.split('-').reverse().join('-'); // Convert to DD-MM-YYYY
    const reason = document.getElementById('reason').value.trim() || "des raisons personnelles";

    // Prepare message template from A2
    const messageTemplate = data.values[1][0]; // A2 cell
    const replacedMessage = messageTemplate
      .replace('[TYPE]', leaveType)
      .replace('[DATE_DEBUT]', startDate)
      .replace('[DATE_FIN]', endDate)
      .replace('[MOTIF]', reason)
      .replace('[DESTINATAIRE]', recipientName);

    // Open WhatsApp link for the selected recipient
    if (recipientNumber) {
      const whatsappLink = `whatsapp://send?text=${encodeURIComponent(replacedMessage)}&phone=${recipientNumber}`;
      window.open(whatsappLink, '_blank');
    }

    // Close modal
    closeLeaveRequestModal();
    alert('Demande envoy√©e avec succ√®s!');

  } catch (error) {
    console.error(error);
    alert('Erreur lors de envoi de la demande');
  }
});
async function populateRecipientDropdown() {
  const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
  const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";
  const demandeCong√©Sheet = "DEMANDE CONG√â";

  try {
    // Fetch data from the spreadsheet
    const response = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${demandeCong√©Sheet}?key=${apiKey}`
    );
    const data = await response.json();

    if (!data.values || data.values.length < 2) {
      alert('Erreur de chargement des donn√©es ou pas de donn√©es disponibles.');
      return;
    }

    // Get the dropdown element
    const recipientSelect = document.getElementById('recipient');

    // Clear existing options (except the default one)
    recipientSelect.innerHTML = '<option value="">S√©lectionnez un responsable</option>';

    // Add names from column B and corresponding WhatsApp numbers from column C
    data.values.slice(1).forEach(row => {
      const name = row[1]; // Column B (name)
      const whatsapp = row[2]; // Column C (WhatsApp number)

      if (name && whatsapp) {
        const option = document.createElement('option');
        option.value = whatsapp; // WhatsApp number as value
        option.textContent = name; // Name as displayed text
        recipientSelect.appendChild(option);
      }
    });
  } catch (error) {
    console.error("Erreur lors du chargement des donn√©es :", error);
    alert('Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.');
  }
}
function openLeaveRequestModal() {
  // Populate the dropdown before showing the modal
  populateRecipientDropdown();

  // Show the modal
  document.getElementById('leaveRequestModal').style.display = 'flex';
}
function openNewUserModal() {
            document.getElementById('newUserModal').style.display = 'flex';
        }

        function closeNewUserModal() {
            document.getElementById('newUserModal').style.display = 'none';
        }

        document.getElementById('newUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const nom = document.getElementById('newUserNom').value.trim();
    
    const username = document.getElementById('newUserUsername').value.trim();
    const password = document.getElementById('newUserPassword').value.trim();

    try {
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® POST ÿ•ŸÑŸâ App Script
        const response = await fetch('https://script.google.com/macros/s/AKfycbygUlNiRt6UxbrGFWEVFjVmScPtkmSgkA-ULXroGrJ_WygCNUTjS9xKCJk6G87HxIr23A/exec', {
            method: 'POST',
            body: JSON.stringify({
                nom: nom,
                
                username: username,
                password: password
            })
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert('Utilisateur enregistr√© avec succ√®s!');
            closeNewUserModal();
        } else {
            alert(result.message);
        }

    } catch (error) {
        console.error(error);
        alert('Erreur lors de l enregistrement');
    }
});
async function fetchAvailableYears() {
    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`
        );
        const data = await response.json();

        // Filtrer les feuilles contenant uniquement des nombres (ann√©es)
        const yearSheets = data.sheets
            .map(sheet => sheet.properties.title)
            .filter(title => /^\d{4}$/.test(title))
            .sort((a, b) => b - a); // Trier les ann√©es du plus r√©cent au plus ancien

        const yearSelect = document.createElement('select');
        yearSelect.id = 'yearSelect';
        yearSelect.style.marginTop = '5px';
        yearSelect.style.fontSize = '10px';
        yearSelect.style.color = '#007bff';

        yearSheets.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });

        // Remplacer le texte statique par la liste d√©roulante
        const yearDisplay = document.getElementById('yearDisplay');
        yearDisplay.innerHTML = ''; // Effacer le contenu actuel
        yearDisplay.appendChild(yearSelect);

        // Ajouter un √©v√©nement de changement pour charger les donn√©es lors de la s√©lection de l'ann√©e
        yearSelect.addEventListener('change', function() {
            const selectedYear = this.value;
            loadUserData(selectedYear);
        });

        // Charger les donn√©es de l'ann√©e en cours par d√©faut
        yearSelect.value = new Date().getFullYear().toString();
        loadUserData(yearSelect.value);

    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des ann√©es :', error);
    }
}

async function loadUserData(selectedYear) {
    const username = document.getElementById("username").value.trim().toLowerCase();
    const password = document.getElementById("password").value.trim();
    const userPassword = `${username}:${password}`;

    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "<div class='loading'>Chargement des donn√©es</div>";

    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${selectedYear}?key=${apiKey}`
        );
        const data = await response.json();

        if (!data.values) {
            resultDiv.innerHTML = "<p class='error-message'>Erreur lors du chargement des donn√©es. V√©rifiez les param√®tres.</p>";
            return;
        }

        const rows = data.values;
        const userRow = rows.find(row => row[26]?.toLowerCase() === userPassword.toLowerCase());

        if (!userRow) {
            resultDiv.innerHTML = "<p class='error-message'>Donn√©es non trouv√©es pour cette ann√©e.</p>";
            return;
        }

        const months = [
            "Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
            "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"
        ];

        let table = `
    <div class="year-header">
        <h3>Cong√©s et Repos " ${selectedYear} "</h3>
    </div>
    <table>
        <thead>
            <tr>
                <th>Mois</th>
                <th>CONG√â</th>
                <th>REPOS</th>
            </tr>
        </thead>
        <tbody>
`;

for (let i = 0; i < months.length; i++) {
    const conge = userRow[2 + i * 2] || "Non disponible";
    const repos = userRow[3 + i * 2] || "Non disponible";
    
    // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑÿ£ÿÆŸäÿ± ÿßŸÑÿ∞Ÿä Ÿäÿ≠ÿ™ŸàŸä ŸÖÿ≠ÿ™ŸàŸâ
    const isLastMonthWithContent = (conge !== "Non disponible" || repos !== "Non disponible") && 
        months.slice(i+1).every(m => {
            const idx = months.indexOf(m);
            const nextConge = userRow[2 + idx * 2] || "Non disponible";
            const nextRepos = userRow[3 + idx * 2] || "Non disponible";
            return nextConge === "Non disponible" && nextRepos === "Non disponible";
        });

    let rowStyle = "";
    if (isLastMonthWithContent) {
        rowStyle = `
            background: linear-gradient(135deg, #66a3e8 0%, #88a0e3 80%);
            border: 2px solid #4a90e2;
            font-weight: bold;
            color: #5c0d0d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        `;
    }
    
    table += `
        <tr style="${rowStyle}">
            <td>${months[i]}</td>
            <td>${conge}</td>
            <td>${repos}</td>
        </tr>
    `;
}
        resultDiv.innerHTML = table;

    } catch (error) {
        console.error(error);
        resultDiv.innerHTML = "<p class='error-message'>Erreur lors du chargement des donn√©es. Veuillez r√©essayer plus tard.</p>";
    }
}

// Modifier l'√©v√©nement original du formulaire
document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    await fetchAvailableYears();
});
async function fetchAvailableYears() {
    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`
        );
        const data = await response.json();

        // Filtrer les feuilles contenant uniquement des nombres (ann√©es)
        const yearSheets = data.sheets
            .map(sheet => sheet.properties.title)
            .filter(title => /^\d{4}$/.test(title))
            .sort((a, b) => b - a); // Trier les ann√©es du plus r√©cent au plus ancien

        const yearSelect = document.createElement('select');
        yearSelect.id = 'yearSelect';
        yearSelect.style.marginTop = '5px';
        yearSelect.style.fontSize = '10px';
        yearSelect.style.color = '#007bff';

        yearSheets.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });

        // Remplacer le texte statique par la liste d√©roulante
        const yearDisplay = document.getElementById('yearDisplay');
        yearDisplay.innerHTML = 'Ann√©e : '; // Ajouter un libell√©
        yearDisplay.appendChild(yearSelect);

        // Ajouter un √©v√©nement de changement pour charger les donn√©es lors de la s√©lection de l'ann√©e
        yearSelect.addEventListener('change', function() {
            const selectedYear = this.value;
            loadUserData(selectedYear);
        });

        // Charger les donn√©es de l'ann√©e en cours par d√©faut
        const currentYear = new Date().getFullYear().toString();
        const defaultYear = yearSheets.includes(currentYear) ? currentYear : yearSheets[0];
        
        yearSelect.value = defaultYear;
        
        // Charger ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ≥ŸÜÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
        return defaultYear;

    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des ann√©es :', error);
        return null;
    }
}

// Modifier l'√©v√©nement original du formulaire
document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const defaultYear = await fetchAvailableYears();
    if (defaultYear) {
        await loadUserData(defaultYear);
    }
});
// ÿØÿßŸÑÿ© ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ£ŸàŸÑŸâ ŸÑŸÑŸÄ Reliquat
function showReliquatModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Page r√©serv√©e √† l'administrateur</h2>
            <form id="reliquatLoginForm">
                <input type="text" id="reliquatUsername" placeholder="Nom d'utilisateur" required>
                <input type="password" id="reliquatPassword" placeholder="Mot de passe" required>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeModal(this)">Annuler</button>
                    <button type="submit" class="submit-btn">Connexion</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    document.getElementById('reliquatLoginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('reliquatUsername').value;
        const password = document.getElementById('reliquatPassword').value;

        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ABDELLAOUI MOHAMMED
        const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
        const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";
        const sheetName = "2024";

        try {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`
            );
            const data = await response.json();
            const rows = data.values;

            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸÅ ABDELLAOUI MOHAMMED
            const userRow = rows.find(row => row[0] === "ABDELLAOUI MOHAMMED");

            if (userRow && userRow[26] === `${username}:${password}`) {
                closeModal(e.target.closest('.modal'));
                
                // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ≥ÿßŸáŸÖÿßÿ™ ŸÖÿπ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ŸÜŸàÿßÿ™ ŸàÿßŸÑÿ£ÿ≥ŸÖÿßÿ°
                showContributionModal(async () => {
                    await fetchAvailableYearsForContribution();
                    await fetchNamesForContribution();
                });
            } else {
                alert("Identifiants incorrects");
            }
        } catch (error) {
            console.error(error);
            alert("Erreur de connexion");
        }
    });
}

// ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© showContributionModal ŸÑÿ™ŸÇÿ®ŸÑ ÿØÿßŸÑÿ© ÿ±ÿØ ÿßŸÑÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©
function showContributionModal(callback = null) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Saisie de donn√©es</h2>
            <form id="contributionForm">
            <input list="yearOptions" id="yearSelect" placeholder="S√©lectionnez ou entrez une ann√©e" required>
<datalist id="yearOptions"></datalist>
                <select id="nameSelect" required>
                    <option value="">S√©lectionnez un nom</option>
                </select>
                <select id="monthSelect" required>
                    <option value="">S√©lectionnez un mois</option>
                    <option value="0">Janvier</option>
                    <option value="1">F√©vrier</option>
                    <option value="2">Mars</option>
                    <option value="3">Avril</option>
                    <option value="4">Mai</option>
                    <option value="5">Juin</option>
                    <option value="6">Juillet</option>
                    <option value="7">Ao√ªt</option>
                    <option value="8">Septembre</option>
                    <option value="9">Octobre</option>
                    <option value="10">Novembre</option>
                    <option value="11">D√©cembre</option>
                </select>
                <input type="text" id="congeInput" placeholder="Cong√©">
                <input type="text" id="reposInput" placeholder="Repos">
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeModal(this)">Annuler</button>
                    <button type="submit" class="submit-btn">Enregistrer</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';

    // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿØÿßŸÑÿ© ÿ±ÿØ ÿßŸÑÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
    if (callback) {
        callback();
    }

    document.getElementById('contributionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const year = document.getElementById('yearSelect').value;
        const name = document.getElementById('nameSelect').value;
        const month = document.getElementById('monthSelect').value;
        const conge = document.getElementById('congeInput').value;
        const repos = document.getElementById('reposInput').value;

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ App Script
        const response = await fetch('https://script.google.com/macros/s/AKfycbzhjECCcMsNThqVbXSFKxWPpUq5RP41t02Eaf_6Vx0GVZbHJPpMDu-9EPuNVqDoDFDk-A/exec', {
            method: 'POST',
            body: JSON.stringify({
                year, name, month, conge, repos
            })
        });

        const result = await response.json();
        if (result.status === 'success') {
            alert('Contribution enregistr√©e avec succ√®s');
        } else {
            alert(result.message);
        }
    });
}

// ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ©
function closeModal(element) {
    const modal = element.closest('.modal');
    modal.style.display = 'none';
    modal.remove();
}

// ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≠ÿØÿ´ ŸÑŸÑŸÄ Reliquat
document.querySelector('.reliquat').addEventListener('click', showReliquatModal);

// ÿØÿßŸÑÿ© ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ≥ŸÜŸàÿßÿ™
async function fetchAvailableYearsForContribution() {
    const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
    const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";

    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?key=${apiKey}`
        );
        const data = await response.json();

        const yearOptions = document.getElementById('yearOptions');
        const yearSheets = data.sheets
            .map(sheet => sheet.properties.title)
            .filter(title => /^\d{4}$/.test(title))
            .sort((a, b) => b - a);

        yearSheets.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            yearOptions.appendChild(option);
        });
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des ann√©es', error);
    }
}

// ÿØÿßŸÑÿ© ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°
async function fetchNamesForContribution() {
    const apiKey = "AIzaSyDN9HjJed_FxRchAOaFlbv7DGs57IWr7cw";
    const spreadsheetId = "1u_k5KNO7oLgq-xxWiUfPjoArQkv0o1wvJGxTxcWXA5Y";
    const sheetName = "2024";

    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`
        );
        const data = await response.json();
        const rows = data.values;

        const nameSelect = document.getElementById('nameSelect');
        const uniqueNames = [...new Set(rows.slice(1).map(row => row[0]))];

        uniqueNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des noms', error);
    }
}


  </script>
</body>
</html>
